
<!DOCTYPE html>
<html>
  <head>
    <title>Value Classes and Universal Traits - Scala Documentation</title>
    
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

    <link rel="icon" type="image/png" href="/resources/favicon.ico">

    <!-- prettify js and CSS -->
    <link rel="stylesheet" href="/resources/stylesheets/prettify.css" type="text/css" />
    <script src="/resources/javascript/prettify/prettify.js" type="text/javascript" ></script>


    <!-- jquery js -->
    <script src="/resources/javascript/jquery.js" type="text/javascript" ></script>
    <script src="/resources/javascript/effects.core.js" type="text/javascript" ></script>
    <script src="/resources/javascript/effects.highlight.js" type="text/javascript" ></script>
    <script src="/resources/javascript/moveScroller.js" type="text/javascript" ></script>

    <!-- Bootstrap JS and CSS -->
    <link rel="stylesheet" href="/resources/stylesheets/bootstrap.css" type="text/css" />
	  <script src="/resources/javascript/bootstrap-dropdown.js" type="text/javascript" ></script>
	  <script src="/resources/javascript/bootstrap-dropdown-app.js" type="text/javascript" ></script>

    <!-- Base stylesheet for all pages -->
    <link rel="stylesheet" href="/resources/stylesheets/base.css" type="text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css" />
    <link rel="stylesheet" href="/resources/stylesheets/search.css" type="text/css" />

    <!-- table of contents js -->
    <script src="/resources/javascript/toc.js" type="text/javascript" ></script>


    <!-- styles for pager and table of contents -->
    <link rel="stylesheet" href="/resources/stylesheets/pager.css" type="text/css" />
    <link rel="stylesheet" href="/resources/stylesheets/toc.css" type="text/css" />

    <!-- google analytics -->
	<script type="text/javascript">

	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-574683-5']);
	  _gaq.push(['_trackPageview']);

	  (function() {
	    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();

	</script>

    <!-- prettyprint js to prepend generated pre/code tags -->
    <script type="text/javascript">
      function styleCode()
        {
          if (typeof disableStyleCode != "undefined")
          {
              return;
          }
          var a = false;
          $("pre code").parent().each(function()
          {
              if (!$(this).hasClass("prettyprint"))
              {
                  $(this).addClass("prettyprint lang-scala linenums");
                  a = true
              }
          });
          if (a) { prettyPrint() }
      }
    </script>

    <script type="text/javascript">
      jQuery(document).ready(function($) {

            $(".scroll").click(function(event){
              event.preventDefault();
              $('html,body').animate({scrollTop:$(this.hash).offset().top}, 500);
              $('html,body').animate({scrollTop:$(this.hash).offset().top-=50}, 500);
              $(this.hash).effect("highlight", {color: "#FFCC85"}, 3000);
            });
      });
    </script>

    <script type="text/javascript">
      $(window).ready(function goToSubsection() {
          if (window.location.hash)
          {
              $('html,body').animate({scrollTop:$(window.location.hash).offset().top}, 500);
              $('html,body').animate({scrollTop:$(window.location.hash).offset().top-=50}, 500);
              $(window.location.hash).effect("highlight", {color: "#FFCC85"}, 3000);
          }
        });
    </script>

    <style type="text/css">

       p.contents {
           margin-left: 15px;
           font-weight: bold;
           font-size: 16px;
       }

       div#toc ul {
           list-style: none;
       }

       div#toc ul a {
           display: block;
           list-style: none;
           line-height: 22px;
           font-weight: bold;
           width: 100%;
       }

      div#toc ul li ul {
           list-style: disc;
      }

      div#toc ul li ul a {
           line-height: 18px;
           font-weight: normal;
      }

      div#toc ul li ul li ul {
           list-style: square;
      }
       div#toc ul li ul li ul a {
       }

       div#scroller-anchor {
           width: inherit;
       }

       div#scroller {
           width: inherit;
       }

       div#guide-title {
        text-transform: capitalize;
        font-size: 16px;
        padding-bottom: 6px;
        color: #BFBFBF;
        text-transform: uppercase;
        font-weight: bold;
       }

       input, textarea, select, .uneditable-input {
	       width: 165px;
	     }

    </style>

</head>
<body onload="styleCode()">

    <!-- Topbar
    ================================================== -->
<div class="topbar">
    <div class="topbar-inner">
        <div class="container">
            <a class="brand" href="/index.html"><img src="/resources/images/scala-logo.png"> Documentation</a>
            <ul class="nav">

                <li class="menu">
                      <a href="#" class="menu">API</a>
                      <ul class="menu-dropdown">
                        <li><a href="http://www.scala-lang.org/api/current/">Current</a></li>
                        <li><a href="http://www.scala-lang.org/files/archive/nightly/2.11.x/api/2.11.x/">Nightly</a></li>
                        <!--<li class="divider"></li>
                        <li><a href="#">Previous Versions</a></li>
                        -->
                      </ul>
                </li>

                <li class="menu">
                      <a href="#" class="menu">Learn</a>
                      <ul class="menu-dropdown">
                        <li><a href="/overviews">Guides & Overviews</a></li>
                        <li><a href="/tutorials">Tutorials</a></li>
                        <li><a href="/style">Scala Style Guide</a></li>
                      </ul>
                </li>

                <li class="menu">
                      <a href="#" class="menu">Quickref</a>
                      <ul class="menu-dropdown">
                        <li><a href="/glossary">Glossary</a></li>
                        <li><a href="/cheatsheets">Cheatsheets</a></li>
                      </ul>
                </li>

                <li><a href="/contribute.html">Contribute</a></li>
                <li><a href="/sips">SIPs/SLIPs</a></li>
                <li>
                    <form id="searchform" action="#">
                        <input type="text" placeholder="Search in documentation..." class="field" name="q" id="q"/>
                    </form>
                </li>
            </ul>
        </div>
    </div>
</div>


<div class="container">
  <div class="row">
    <div class="span10"><h1>Value Classes and Universal Traits</h1></div>

    

    

    

    <div class="span6">
      
      <ul class="langbar">
        <li><a href="/overviews/core/value-classes" class="lang">English</a></li>
        
          
          <li><a href="/ja/overviews/core/value-classes" class="lang">日本語</a></li>
        
          
          <li><a href="/zh-cn/overviews/core/value-classes" class="lang">中文 (简体)</a></li>
        
      </ul>
      
    </div>

    <div class="span10">
      <p><strong>Mark Harrah 著</strong></p>

<h2 id="section">引言</h2>

<p>Value classes是在<a href="http://docs.scala-lang.org/sips/pending/value-classes.html">SIP-15</a>中提出的一种通过继承AnyVal类来避免运行时对象分配的新机制。以下是一个最简的value class。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class Wrapper(val underlying: Int) extends AnyVal
</code></pre>
</div>

<p>它仅有一个被用作运行时底层表示的公有val参数。在编译期，其类型为Wrapper，但在运行时，它被表示为一个Int。Value class可以带有def定义，但不能再定义额外的val、var，以及内嵌的trait、class或object：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class Wrapper(val underlying: Int) extends AnyVal {
  def foo: Wrapper = new Wrapper(underlying * 19)
}
</code></pre>
</div>

<p>Value class只能继承universal traits，但其自身不能再被继承。所谓universal trait就是继承自Any的、只有def成员，且不作任何初始化工作的trait。继承自某个universal trait的value class同时继承了该trait的方法，但是（调用这些方法）会带来一定的对象分配开销。例如：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>trait Printable extends Any {
  def print(): Unit = println(this)
}
class Wrapper(val underlying: Int) extends AnyVal with Printable

val w = new Wrapper(3)
w.print() // 这里实际上会生成一个Wrapper类的实例
</code></pre>
</div>

<p>本文后续篇幅将介绍相关用例和与对象分配时机相关的细节，并给出一些有关value class自身限制的具体实例。</p>

<h2 id="section-1">扩展方法</h2>

<p>关于value类的一个用例，是将它们和隐含类联合（<a href="http://docs.scala-lang.org/sips/pending/implicit-classes.html">SIP-13</a>）以获得免分配扩展方法。使用隐含类可以提供便捷的语法来定义扩展方法，同时 value 类移除运行时开销。一个好的例子是在标准库里的RichInt类。RichInt 继承自Int类型并附带一些方法。由于它是一个 value类，使用RichInt 方法时不需要创建一个RichInt 的实例。</p>

<p>下面有关RichInt的代码片段示范了RichInt是如何继承Int来允许3.toHexString的表达式：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>implicit class RichInt(val self: Int) extends AnyVal {
  def toHexString: String = java.lang.Integer.toHexString(self)
}
</code></pre>
</div>

<p>在运行时，表达式3.toHexString 被优化并等价于静态对象的方法调用 （RichInt$.MODULE$.extension$toHexString(3)），而不是创建一个新实例对象，再调用其方法。</p>

<h2 id="section-2">正确性</h2>

<p>关于value类的另一个用例是：不增加运行时开销的同时，获得数据类型的类型安全。例如，一个数据类型片断代表一个距离 ，如：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class Meter(val value: Double) extends AnyVal {
  def +(m: Meter): Meter = new Meter(value + m.value)
}
</code></pre>
</div>

<p>代码：对两个距离进行相加，例如：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>val x = new Meter(3.4)
val y = new Meter(4.3)
val z = x + y
</code></pre>
</div>

<p>实际上不会分配任何Meter实例，而是在运行时仅使用原始双精浮点数（double） 。</p>

<p>注意：在实践中，可以使用条件类（case）and/or 扩展方法来让语句更清晰。</p>

<h2 id="section-3">必须进行分配的情况</h2>

<p>由于JVM不支持value类，Scala 有时需要真正实例化value类。详细细节见[SIP-15]。</p>

<h3 id="section-4">分配概要</h3>

<p>value类在以下情况下，需要真正实例化：</p>

<ol>
  <li>value类作为另一种类型使用时。</li>
  <li>value类被赋值给数组。</li>
  <li>执行运行时类型测试，例如模式匹配。</li>
</ol>

<h3 id="section-5">分配细节</h3>

<p>无论何时，将value类作为另一种类型进行处理时（包括universal trait），此value类实例必须被实例化。例如，value类Meter ：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>trait Distance extends Any
case class Meter(val value: Double) extends AnyVal with Distance
</code></pre>
</div>

<p>接收Distance类型值的方法需要一个正真的Meter实例。下面的例子中，Meter类真正被实例化。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>def add(a: Distance, b: Distance): Distance = ...
add(Meter(3.4), Meter(4.3))
</code></pre>
</div>

<p>如果替换add方法的签名：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>def add(a: Meter, b: Meter): Meter = ...
</code></pre>
</div>

<p>那么就不必进行分配了。此规则的另一个例子是value类作为类型参数使用。例如：即使是调用identity方法，也必须创建真正的Meter实例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>def identity[T](t: T): T = t
identity(Meter(5.0))
</code></pre>
</div>

<p>必须进行分配的另一种情况是：将它赋值给数组。即使这个数组就是value类数组，例如：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>val m = Meter(5.0)
val array = Array[Meter](m)
</code></pre>
</div>

<p>数组中包含了真正的Meter 实例，并不只是底层基本类型double。</p>

<p>最后是类型测试。例如，模式匹配中的处理以及asInstanceOf方法都要求一个真正的value类实例：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>case class P(val i: Int) extends AnyVal

val p = new P(3)
p match { // 在这里，新的P实例被创建
  case P(3) =&gt; println("Matched 3")
  case P(x) =&gt; println("Not 3")
}
</code></pre>
</div>

<h2 id="section-6">限制</h2>

<p>目前Value类有一些限制，部分原因是JVM不提供value类概念的原生支持。value类的完整实现细节及其限制见[SIP-15]。</p>

<h3 id="section-7">限制概要</h3>

<p>一个value类 …</p>

<ol>
  <li>… 必须只有一个public的构造函数。并有且只有一个public的，类型不为value类的val参数。</li>
  <li>… 不能有特殊的类型参数.</li>
  <li>… 不能有嵌套或本地类、trait或对象。</li>
  <li>… 不能定义equals或hashCode方法。</li>
  <li>… 必须是一个顶级类，或静态访问对象的一个成员</li>
  <li>… 仅能有def为成员。尤其是，成员不能有惰性val、val或者var 。</li>
  <li>… 不能被其它类继承。</li>
</ol>

<h3 id="section-8">限制示例</h3>

<p>本章节列出了许多限制下具体影响， 而在“必要分配”章节已提及的部分则不再敖述。</p>

<p>构造函数不允许有多个参数：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class Complex(val real: Double, val imag: Double) extends AnyVal
</code></pre>
</div>

<p>则Scala编译器将生成以下的错误信息：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Complex.scala:1: error: value class needs to have exactly one public val parameter
（Complex.scala:1: 错误：value类只能有一个public的val参数。）
（译者注：鉴于实际中编译器输出的可能是英文信息，在此提供双语。）
class Complex(val real: Double, val imag: Double) extends AnyVal
      ^
</code></pre>
</div>

<p>由于构造函数参数必须是val，而不能是一个按名（by-name）参数：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>NoByName.scala:1: error: `val' parameters may not be call-by-name
（NoByName.scala:1: 错误: `val' 不能为 call-by-name）
class NoByName(val x: =&gt; Int) extends AnyVal
                      ^
</code></pre>
</div>

<p>Scala不允许惰性val作为构造函数参数， 所以value类也不允许。并且不允许多个构造函数。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class Secondary(val x: Int) extends AnyVal {
  def this(y: Double) = this(y.toInt)
}

Secondary.scala:2: error: value class may not have secondary constructors
（Secondary.scala:2: 错误：value类不能有第二个构造函数。）
  def this(y: Double) = this(y.toInt)
      ^
</code></pre>
</div>

<p>value class不能将惰性val或val作为成员，也不能有嵌套类、trait或对象。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class NoLazyMember(val evaluate: () =&gt; Double) extends AnyVal {
  val member: Int = 3
  lazy val x: Double = evaluate()
  object NestedObject
  class NestedClass
}

Invalid.scala:2: error: this statement is not allowed in value class: private[this] val member: Int = 3
（Invalid.scala:2: 错误: value类中不允许此表达式：private [this] val member: Int = 3）
  val member: Int = 3
      ^
Invalid.scala:3: error: this statement is not allowed in value class: lazy private[this] var x: Double = NoLazyMember.this.evaluate.apply()
（Invalid.scala:3: 错误：value类中不允许此表达式： lazy private[this] var x: Double = NoLazyMember.this.evaluate.apply()）
  lazy val x: Double = evaluate()
           ^
Invalid.scala:4: error: value class may not have nested module definitions
（Invalid.scala:4: 错误: value类中不能定义嵌套模块）
  object NestedObject
         ^
Invalid.scala:5: error: value class may not have nested class definitions
（Invalid.scala:5: 错误：value类中不能定义嵌套类）
  class NestedClass
        ^
</code></pre>
</div>

<p>注意：value类中也不允许出现本地类、trait或对象，如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class NoLocalTemplates(val x: Int) extends AnyVal {
  def aMethod = {
    class Local
    ...
  }
}
</code></pre>
</div>

<p>在目前value类实现的限制下，value类不能嵌套：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class Outer(val inner: Inner) extends AnyVal
class Inner(val value: Int) extends AnyVal

Nested.scala:1: error: value class may not wrap another user-defined value class
（Nested.scala:1:错误：vlaue类不能包含另一个用户定义的value类）
class Outer(val inner: Inner) extends AnyVal
                ^
</code></pre>
</div>

<p>此外，结构类型不能使用value类作为方法的参数或返回值类型。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class Value(val x: Int) extends AnyVal
object Usage {
  def anyValue(v: { def value: Value }): Value =
    v.value
}

Struct.scala:3: error: Result type in structural refinement may not refer to a user-defined value class
（Struct.scala:3: 错误: 结构细化中的结果类型不适用于用户定义的value类）
  def anyValue(v: { def value: Value }): Value =
                               ^
</code></pre>
</div>

<p>value类不能继承non-universal trait，并且其本身不能被继承：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>trait NotUniversal
class Value(val x: Int) extends AnyVal with notUniversal
class Extend(x: Int) extends Value(x)

Extend.scala:2: error: illegal inheritance; superclass AnyVal
 is not a subclass of the superclass Object
 of the mixin trait NotUniversal
（Extend.scala:2: 错误：非法继承：父类AnyVal不是一个父类对象（混入trait NotUniversal）的子类）
class Value(val x: Int) extends AnyVal with NotUniversal
                                            ^
Extend.scala:3: error: illegal inheritance from final class Value
（Extend.scala:3: 错误: 从Value类（final类）非法继承）
class Extend(x: Int) extends Value(x)
                             ^
</code></pre>
</div>

<p>第二条错误信息显示：虽然value类没有显式地用final关键字修饰，但依然认为value类是final类。</p>

<p>另一个限制是：一个类仅支持单个参数的话，则value类必须是顶级类，或静态访问对象的成员。这是由于嵌套value类需要第二个参数来引用封闭类。所以不允许下述代码：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class Outer {
  class Inner(val x: Int) extends AnyVal
}

Outer.scala:2: error: value class may not be a member of another class
（Outer.scala:2: 错误：value类不能作为其它类的成员）
class Inner(val x: Int) extends AnyVal
      ^
</code></pre>
</div>

<p>但允许下述代码，因为封闭对象是顶级类：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>object Outer {
  class Inner(val x: Int) extends AnyVal
}
</code></pre>
</div>


      <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  
    var disqus_shortname = 'scalasip'; // required: replace example with your forum shortname
  

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>
    
    <div class="span6">
      <div id="scroller-anchor">
  <div id="scroller">
              
    <p class="contents">Contents</p>
    <div id="toc"></div>    
  </div>
</div>

    </div>
    
	
  </div>
</div>

<div class="footer">
	<div class="container">
		<ul>
			<li><h5>API</h5></li>
			<li><a href="http://www.scala-lang.org/api/current/">Current</a></li>
			<li><a href="http://www.scala-lang.org/files/archive/nightly/2.11.x/api/2.11.x/">Nightly</a></li>
		</ul>
		<ul>
			<li><h5>Learn</h5></li>
			<li><a href="/overviews">Guides & Overviews</a></li>
			<li><a href="/tutorials">Tutorials</a></li>
			<li><a href="/style">Scala Style Guide</a></li>
		</ul>
		<ul>
			<li><h5>Quickref</h5></li>
			<li><a href="/glossary">Glossary</a></li>
			<li><a href="/cheatsheets">Cheatsheets</a></li>
		</ul>
		<ul>
			<li><h5>Contribute</h5></li>
			<li><a href="http://github.com/scala/scala.github.com">Source Code</a></li>
			<li><a href="/contribute.html">Contributors Guide</a></li>
			<li><a href="http://getsatisfaction.com/scaladocs">Suggestions</a></li>
		</ul>
		<ul>
			<li><h5>Other Resources</h5></li>
			<li><a href="/sips">Scala Improvement Process</a></li>
		</ul>
	</div>
	<div class="container copyright">
 		<p>
			Copyright &copy; 2011-2015 EPFL. All rights reserved.
			<a href="https://github.com/scala/scala.github.com/commits/gh-pages.atom"><img align="right" height="20px" width="20px" src="/resources/images/rss.png" alt="RSS feed of updates to the github repo hosting this site"></a>
		</p>
	</div>
</div>

<!-- search -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
<script type="text/javascript"> docsearch({
  apiKey: 'b66eaeec6bd214ea6c0fcd2d7b7fdfe8',
  indexName: 'scala-docs',
  inputSelector: '#q',
	autocompleteOptions: {
    debug: true
  },
  algoliaOptions: {
		"hitsPerPage": 5,
		"facetFilters": "(tags:en)"
	}
});
</script>



<script type="text/javascript">
  $('#toc').toc({exclude: 'h1, h5, h6', context: '', autoId: true, numerate: false});
</script>

<script type="text/javascript">
  $(function() {
    moveScroller();
  });
</script>

  </body>
</html>

    
